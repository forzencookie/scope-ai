-- ============================================================================
-- SFL 11 kap: SKV Tax Tables for payroll withholding
-- Swedish law requires withholding based on Skatteverket's published tax tables
-- (varies by municipality and income bracket), not flat percentage rates.
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.skv_tax_tables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    year INTEGER NOT NULL,
    table_number INTEGER NOT NULL,       -- SKV table number (29-40 typically)
    column_number INTEGER NOT NULL DEFAULT 1,  -- 1-6
    income_from INTEGER NOT NULL,        -- Monthly income bracket start (SEK)
    income_to INTEGER NOT NULL,          -- Monthly income bracket end (SEK)
    tax_deduction INTEGER NOT NULL,      -- Tax to withhold (SEK)
    CONSTRAINT uq_skv_bracket UNIQUE(year, table_number, column_number, income_from)
);

-- RLS: authenticated users can read
ALTER TABLE skv_tax_tables ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read tax tables"
    ON skv_tax_tables FOR SELECT
    TO authenticated
    USING (true);

GRANT SELECT ON skv_tax_tables TO authenticated;
GRANT ALL ON skv_tax_tables TO service_role;

CREATE INDEX idx_skv_tax_tables_lookup
    ON skv_tax_tables(year, table_number, column_number, income_from);

COMMENT ON TABLE skv_tax_tables IS 'SKV tax withholding tables per SFL 11 kap. Tables 29-40 cover most municipalities.';

-- ============================================================================
-- Seed 2025 tax table data (column 1 = standard, most common tables)
-- Source: Skatteverket tax table 2025
-- These are representative bracket ranges. Real production data should be
-- imported from SKV's published CSV files.
-- ============================================================================

-- Table 30 (common for Stockholm-area municipalities, ~32% kommunalskatt)
INSERT INTO skv_tax_tables (year, table_number, column_number, income_from, income_to, tax_deduction) VALUES
    (2025, 30, 1, 0, 2200, 0),
    (2025, 30, 1, 2201, 4100, 0),
    (2025, 30, 1, 4101, 7200, 0),
    (2025, 30, 1, 7201, 8500, 600),
    (2025, 30, 1, 8501, 10000, 900),
    (2025, 30, 1, 10001, 12000, 1250),
    (2025, 30, 1, 12001, 14000, 1700),
    (2025, 30, 1, 14001, 16000, 2200),
    (2025, 30, 1, 16001, 18000, 2800),
    (2025, 30, 1, 18001, 20000, 3400),
    (2025, 30, 1, 20001, 22000, 4000),
    (2025, 30, 1, 22001, 24000, 4700),
    (2025, 30, 1, 24001, 26000, 5400),
    (2025, 30, 1, 26001, 28000, 6100),
    (2025, 30, 1, 28001, 30000, 6800),
    (2025, 30, 1, 30001, 32500, 7600),
    (2025, 30, 1, 32501, 35000, 8500),
    (2025, 30, 1, 35001, 37500, 9400),
    (2025, 30, 1, 37501, 40000, 10300),
    (2025, 30, 1, 40001, 42500, 11300),
    (2025, 30, 1, 42501, 45000, 12200),
    (2025, 30, 1, 45001, 47500, 13200),
    (2025, 30, 1, 47501, 50000, 14200),
    (2025, 30, 1, 50001, 55000, 15800),
    (2025, 30, 1, 55001, 60000, 18100),
    (2025, 30, 1, 60001, 70000, 21400),
    (2025, 30, 1, 70001, 80000, 25800),
    (2025, 30, 1, 80001, 90000, 30600),
    (2025, 30, 1, 90001, 100000, 35600),
    (2025, 30, 1, 100001, 999999, 40000);

-- Table 31 (slightly higher municipal tax)
INSERT INTO skv_tax_tables (year, table_number, column_number, income_from, income_to, tax_deduction) VALUES
    (2025, 31, 1, 0, 2200, 0),
    (2025, 31, 1, 2201, 4100, 0),
    (2025, 31, 1, 4101, 7200, 0),
    (2025, 31, 1, 7201, 8500, 650),
    (2025, 31, 1, 8501, 10000, 950),
    (2025, 31, 1, 10001, 12000, 1350),
    (2025, 31, 1, 12001, 14000, 1800),
    (2025, 31, 1, 14001, 16000, 2350),
    (2025, 31, 1, 16001, 18000, 2950),
    (2025, 31, 1, 18001, 20000, 3550),
    (2025, 31, 1, 20001, 22000, 4200),
    (2025, 31, 1, 22001, 24000, 4900),
    (2025, 31, 1, 24001, 26000, 5600),
    (2025, 31, 1, 26001, 28000, 6400),
    (2025, 31, 1, 28001, 30000, 7100),
    (2025, 31, 1, 30001, 32500, 7900),
    (2025, 31, 1, 32501, 35000, 8800),
    (2025, 31, 1, 35001, 37500, 9800),
    (2025, 31, 1, 37501, 40000, 10800),
    (2025, 31, 1, 40001, 42500, 11800),
    (2025, 31, 1, 42501, 45000, 12800),
    (2025, 31, 1, 45001, 47500, 13800),
    (2025, 31, 1, 47501, 50000, 14800),
    (2025, 31, 1, 50001, 55000, 16400),
    (2025, 31, 1, 55001, 60000, 18900),
    (2025, 31, 1, 60001, 70000, 22300),
    (2025, 31, 1, 70001, 80000, 26800),
    (2025, 31, 1, 80001, 90000, 31800),
    (2025, 31, 1, 90001, 100000, 37000),
    (2025, 31, 1, 100001, 999999, 41500);

-- Table 33 (common moderate municipal tax ~33%)
INSERT INTO skv_tax_tables (year, table_number, column_number, income_from, income_to, tax_deduction) VALUES
    (2025, 33, 1, 0, 2200, 0),
    (2025, 33, 1, 2201, 4100, 0),
    (2025, 33, 1, 4101, 7200, 0),
    (2025, 33, 1, 7201, 8500, 750),
    (2025, 33, 1, 8501, 10000, 1100),
    (2025, 33, 1, 10001, 12000, 1550),
    (2025, 33, 1, 12001, 14000, 2050),
    (2025, 33, 1, 14001, 16000, 2600),
    (2025, 33, 1, 16001, 18000, 3250),
    (2025, 33, 1, 18001, 20000, 3900),
    (2025, 33, 1, 20001, 22000, 4600),
    (2025, 33, 1, 22001, 24000, 5300),
    (2025, 33, 1, 24001, 26000, 6100),
    (2025, 33, 1, 26001, 28000, 6800),
    (2025, 33, 1, 28001, 30000, 7600),
    (2025, 33, 1, 30001, 32500, 8500),
    (2025, 33, 1, 32501, 35000, 9500),
    (2025, 33, 1, 35001, 37500, 10500),
    (2025, 33, 1, 37501, 40000, 11600),
    (2025, 33, 1, 40001, 42500, 12600),
    (2025, 33, 1, 42501, 45000, 13700),
    (2025, 33, 1, 45001, 47500, 14800),
    (2025, 33, 1, 47501, 50000, 15900),
    (2025, 33, 1, 50001, 55000, 17600),
    (2025, 33, 1, 55001, 60000, 20300),
    (2025, 33, 1, 60001, 70000, 24000),
    (2025, 33, 1, 70001, 80000, 28800),
    (2025, 33, 1, 80001, 90000, 34000),
    (2025, 33, 1, 90001, 100000, 39500),
    (2025, 33, 1, 100001, 999999, 44000);

-- Table 34 (common higher municipal tax ~34%)
INSERT INTO skv_tax_tables (year, table_number, column_number, income_from, income_to, tax_deduction) VALUES
    (2025, 34, 1, 0, 2200, 0),
    (2025, 34, 1, 2201, 4100, 0),
    (2025, 34, 1, 4101, 7200, 0),
    (2025, 34, 1, 7201, 8500, 800),
    (2025, 34, 1, 8501, 10000, 1150),
    (2025, 34, 1, 10001, 12000, 1650),
    (2025, 34, 1, 12001, 14000, 2150),
    (2025, 34, 1, 14001, 16000, 2750),
    (2025, 34, 1, 16001, 18000, 3400),
    (2025, 34, 1, 18001, 20000, 4100),
    (2025, 34, 1, 20001, 22000, 4800),
    (2025, 34, 1, 22001, 24000, 5500),
    (2025, 34, 1, 24001, 26000, 6300),
    (2025, 34, 1, 26001, 28000, 7100),
    (2025, 34, 1, 28001, 30000, 7900),
    (2025, 34, 1, 30001, 32500, 8800),
    (2025, 34, 1, 32501, 35000, 9800),
    (2025, 34, 1, 35001, 37500, 10900),
    (2025, 34, 1, 37501, 40000, 12000),
    (2025, 34, 1, 40001, 42500, 13000),
    (2025, 34, 1, 42501, 45000, 14100),
    (2025, 34, 1, 45001, 47500, 15200),
    (2025, 34, 1, 47501, 50000, 16400),
    (2025, 34, 1, 50001, 55000, 18200),
    (2025, 34, 1, 55001, 60000, 20900),
    (2025, 34, 1, 60001, 70000, 24800),
    (2025, 34, 1, 70001, 80000, 29600),
    (2025, 34, 1, 80001, 90000, 35100),
    (2025, 34, 1, 90001, 100000, 40800),
    (2025, 34, 1, 100001, 999999, 45500);

-- Table 36 (higher municipal tax ~35-36%)
INSERT INTO skv_tax_tables (year, table_number, column_number, income_from, income_to, tax_deduction) VALUES
    (2025, 36, 1, 0, 2200, 0),
    (2025, 36, 1, 2201, 4100, 0),
    (2025, 36, 1, 4101, 7200, 0),
    (2025, 36, 1, 7201, 8500, 900),
    (2025, 36, 1, 8501, 10000, 1300),
    (2025, 36, 1, 10001, 12000, 1800),
    (2025, 36, 1, 12001, 14000, 2400),
    (2025, 36, 1, 14001, 16000, 3000),
    (2025, 36, 1, 16001, 18000, 3700),
    (2025, 36, 1, 18001, 20000, 4500),
    (2025, 36, 1, 20001, 22000, 5300),
    (2025, 36, 1, 22001, 24000, 6100),
    (2025, 36, 1, 24001, 26000, 6900),
    (2025, 36, 1, 26001, 28000, 7800),
    (2025, 36, 1, 28001, 30000, 8600),
    (2025, 36, 1, 30001, 32500, 9600),
    (2025, 36, 1, 32501, 35000, 10700),
    (2025, 36, 1, 35001, 37500, 11900),
    (2025, 36, 1, 37501, 40000, 13100),
    (2025, 36, 1, 40001, 42500, 14200),
    (2025, 36, 1, 42501, 45000, 15400),
    (2025, 36, 1, 45001, 47500, 16600),
    (2025, 36, 1, 47501, 50000, 17900),
    (2025, 36, 1, 50001, 55000, 19800),
    (2025, 36, 1, 55001, 60000, 22800),
    (2025, 36, 1, 60001, 70000, 26800),
    (2025, 36, 1, 70001, 80000, 32000),
    (2025, 36, 1, 80001, 90000, 37800),
    (2025, 36, 1, 90001, 100000, 43800),
    (2025, 36, 1, 100001, 999999, 48500);
